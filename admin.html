<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Monitoring Deviasi</title>

<style>
body{font-family:Arial;margin:0;background:#eef3f8}

.header{
  background:#4e73a8;color:white;padding:15px;
  text-align:center;font-size:20px;font-weight:bold;
  position:relative
}

.logout{
  position:absolute;right:20px;top:12px;
  background:white;color:#4e73a8;border:none;
  padding:6px 12px;border-radius:4px;
  cursor:pointer;font-weight:bold
}

.container{padding:20px}

.filters{
  background:white;padding:12px;margin-bottom:15px;border-radius:6px;
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
  display:flex;flex-wrap:wrap;gap:10px
}
.filters select,.filters input{padding:6px;font-size:13px}

table{width:100%;border-collapse:collapse;background:white;font-size:13px}
th,td{border:1px solid #d1d3e2;padding:6px;text-align:center}
th{background:#4e73a8;color:white}
.subhead{background:#e9eef7;font-weight:bold}
td.left{text-align:left}

/* ===== WARNA DEVIASI ===== */
.dev-green{background:#d4edda;color:#155724;font-weight:bold}
.dev-yellow{background:#fff3cd;color:#856404;font-weight:bold}
.dev-red{background:#f8d7da;color:#721c24;font-weight:bold}

/* ===== PAGINATION ===== */
.pagination{
  margin-top:10px;
  display:flex;
  gap:5px;
  flex-wrap:wrap;
}
.page-btn{
  padding:4px 8px;
  border:1px solid #4e73a8;
  background:white;
  cursor:pointer;
}

/* ===== LOADING ===== */
.loading{
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(255,255,255,0.8);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
  font-size:18px;
  color:#4e73a8;
  font-weight:bold;
}
.hidden{display:none}
</style>
</head>

<body>

<script>
// proteksi admin
if(localStorage.getItem("isAdmin")!=="1"){
  alert("Akses ditolak");
  window.location.href="index.html";
}
</script>

<div class="header">
  Monitoring Deviasi Kanwil DJPb Prov. Sumatera Barat
  <button class="logout" onclick="logout()">Logout</button>
</div>

<div id="loading" class="loading">Sedang memuat data...</div>

<div class="container">

<div class="filters">
  <select id="fPeriode"><option value="">Semua Bulan</option></select>
  <select id="fKPPN"><option value="">Semua KPPN</option></select>
  <select id="fBagian"><option value="">Semua BA</option></select>
  <select id="fEselon" disabled><option value="">Semua Eselon 1</option></select>
  <input type="text" id="search" placeholder="Cari Satker / Nama">
</div>

<table id="tbl">
<thead>
<tr>
  <th rowspan="2">No</th>
  <th rowspan="2">Kode Satker</th>
  <th rowspan="2">Nama Satker</th>
  <th colspan="4">Rencana</th>
  <th colspan="4">Realisasi</th>
  <th colspan="4">Deviasi Nominal</th>
  <th colspan="4">Persentase Deviasi</th>
</tr>
<tr class="subhead">
  <th>51</th><th>52</th><th>53</th><th>57</th>
  <th>51</th><th>52</th><th>53</th><th>57</th>
  <th>51</th><th>52</th><th>53</th><th>57</th>
  <th>51</th><th>52</th><th>53</th><th>57</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div style="margin-top:10px">
  <button onclick="toggleAll()" id="btnAll"
    style="padding:6px 12px;border:1px solid #4e73a8;background:white;cursor:pointer">
    Tampilkan Semua
  </button>
</div>

<div class="pagination" id="pagination"></div>

</div>

<script>
const URL="https://script.google.com/macros/s/AKfycbw3ceeaj7oQVcPuvnpXNpWanUl-mXSw_ChODDwJrrUCtVrLpKvCZa8_L1ugClCOUgyK/exec";

let allRows=[];
let filtered=[];
let currentPage=1;
const pageSize=10;
let showAll=false;

const loadingEl=document.getElementById("loading");

const namaBulan={
  "1":"Januari","2":"Februari","3":"Maret","4":"April",
  "5":"Mei","6":"Juni","7":"Juli","8":"Agustus",
  "9":"September","10":"Oktober","11":"November","12":"Desember"
};

const defaultPeriode=String(new Date().getMonth()+1);

// ===== FETCH =====
loadingEl.classList.remove("hidden");

fetch(URL)
.then(r=>r.json())
.then(data=>{
  if(data.status!=="ok"){
    loadingEl.textContent="Gagal memuat data";
    return;
  }

  allRows=data.rows.map(r=>{
    const es=String(r.kodeEselon1||"");
    const eselon1=es.slice(-2);
    const bagian=es.slice(0,-2);
    return {...r,eselon1,bagian};
  });

  initFilters();
  applyFilter();
  loadingEl.classList.add("hidden");
})
.catch(()=>{
  loadingEl.textContent="Gagal memuat data";
});

// ===== FILTER =====
function initFilters(){
  fillBulan("fPeriode",[...new Set(allRows.map(r=>String(r.periode)))]);
  fill("fKPPN",[...new Set(allRows.map(r=>r.kodeKPPN))].sort((a,b)=>a-b));
  fill("fBagian",[...new Set(allRows.map(r=>r.bagian))].sort((a,b)=>a-b));
  fill("fEselon",[...new Set(allRows.map(r=>r.eselon1))].sort((a,b)=>a-b));

  document.getElementById("fPeriode").value=defaultPeriode;
}

function fill(id,arr){
  const sel=document.getElementById(id);
  arr.forEach(v=>{
    const o=document.createElement("option");
    o.value=v;
    o.textContent=v;
    sel.appendChild(o);
  });
}

function fillBulan(id,arr){
  const sel=document.getElementById(id);
  arr.sort((a,b)=>a-b).forEach(v=>{
    const o=document.createElement("option");
    o.value=v;
    o.textContent=namaBulan[v]||("Bulan "+v);
    sel.appendChild(o);
  });
}

document.querySelectorAll("#search,#fPeriode,#fKPPN,#fBagian,#fEselon")
.forEach(el=>el.addEventListener("input",()=>{
  currentPage=1;
  applyFilter();
}));

function applyFilter(){
  const s=document.getElementById("search").value.toLowerCase();
  const p=document.getElementById("fPeriode").value||defaultPeriode;
  const k=document.getElementById("fKPPN").value;
  const b=document.getElementById("fBagian").value;
  const e=document.getElementById("fEselon").value;

  document.getElementById("fEselon").disabled=!b;

  filtered=allRows.filter(r=>{
    if(p && String(r.periode)!==String(p)) return false;
    if(k && String(r.kodeKPPN)!==String(k)) return false;
    if(b && String(r.bagian)!==String(b)) return false;
    if(e && String(r.eselon1)!==String(e)) return false;

    if(s){
      const txt=(r.kodeSatker+" "+r.namaSatker).toLowerCase();
      if(!txt.includes(s)) return false;
    }
    return true;
  });

  renderTable();
  renderPagination();
}

// ===== FORMAT =====
function formatNumber(n){
  if(n==null||n==="") return "";
  return Number(n).toLocaleString("id-ID");
}

function deviasiCell(nominal,persen){
  nominal=Number(nominal)||0;
  persen=Number(persen)||0;

  let cls="";

  if(persen===0){
    cls="dev-green";
  }else if(persen>0 && persen<=5){
    cls="dev-yellow";
  }else if(persen>5){
    cls="dev-red";
  }

  return `<span class="${cls}">${formatNumber(nominal)}</span>`;
}

// ===== TABLE =====
function renderTable(){
  const tbody=document.querySelector("#tbl tbody");
  tbody.innerHTML="";

  let pageRows;
  let start=0;

  if(showAll){
    pageRows=filtered;
  }else{
    start=(currentPage-1)*pageSize;
    pageRows=filtered.slice(start,start+pageSize);
  }

  pageRows.forEach((row,i)=>{
    const tr=document.createElement("tr");

    tr.innerHTML=`
      <td>${start+i+1}</td>
      <td>${row.kodeSatker}</td>
      <td class="left">${row.namaSatker}</td>

      <td>${formatNumber(row.rencana["51"])}</td>
      <td>${formatNumber(row.rencana["52"])}</td>
      <td>${formatNumber(row.rencana["53"])}</td>
      <td>${formatNumber(row.rencana["57"])}</td>

      <td>${formatNumber(row.realisasi["51"])}</td>
      <td>${formatNumber(row.realisasi["52"])}</td>
      <td>${formatNumber(row.realisasi["53"])}</td>
      <td>${formatNumber(row.realisasi["57"])}</td>

      <td>${deviasiCell(row.deviasiNominal["51"],row.deviasiPersen["51"])}</td>
      <td>${deviasiCell(row.deviasiNominal["52"],row.deviasiPersen["52"])}</td>
      <td>${deviasiCell(row.deviasiNominal["53"],row.deviasiPersen["53"])}</td>
      <td>${deviasiCell(row.deviasiNominal["57"],row.deviasiPersen["57"])}</td>

      <td>${deviasiCell(row.deviasiPersen["51"],row.deviasiPersen["51"])}</td>
      <td>${deviasiCell(row.deviasiPersen["52"],row.deviasiPersen["52"])}</td>
      <td>${deviasiCell(row.deviasiPersen["53"],row.deviasiPersen["53"])}</td>
      <td>${deviasiCell(row.deviasiPersen["57"],row.deviasiPersen["57"])}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ===== PAGINATION =====
function renderPagination(){
  const div=document.getElementById("pagination");
  div.innerHTML="";

  if(showAll){
    div.style.display="none";
    return;
  }else{
    div.style.display="flex";
  }

  const totalPages=Math.ceil(filtered.length/pageSize);
  if(totalPages<=1) return;

  const first=document.createElement("div");
  first.textContent="⏮";
  first.className="page-btn";
  first.onclick=()=>{currentPage=1;applyFilter();};
  div.appendChild(first);

  const prev=document.createElement("div");
  prev.textContent="◀";
  prev.className="page-btn";
  prev.onclick=()=>{if(currentPage>1){currentPage--;applyFilter();}};
  div.appendChild(prev);

  const info=document.createElement("div");
  info.textContent=`${currentPage}/${totalPages}`;
  info.style.padding="4px 8px";
  div.appendChild(info);

  const next=document.createElement("div");
  next.textContent="▶";
  next.className="page-btn";
  next.onclick=()=>{if(currentPage<totalPages){currentPage++;applyFilter();}};
  div.appendChild(next);

  const last=document.createElement("div");
  last.textContent="⏭";
  last.className="page-btn";
  last.onclick=()=>{currentPage=totalPages;applyFilter();};
  div.appendChild(last);
}

// ===== TOGGLE =====
function toggleAll(){
  showAll=!showAll;
  document.getElementById("btnAll").textContent=
    showAll?"Gunakan Pagination":"Tampilkan Semua";
  renderTable();
  renderPagination();
}

// ===== LOGOUT =====
function logout(){
  localStorage.removeItem("isAdmin");
  localStorage.removeItem("satker");
  window.location.href="index.html";
}
</script>

</body>
</html>