<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monitoring Deviasi</title>

<style>
body{font-family:Arial;margin:0;background:#eef3f8}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:15px 25px;
  background:#4e73a8;
  color:white;
}

.logout-btn{
  background:#d9534f;
  border:none;
  padding:8px 15px;
  color:white;
  cursor:pointer;
  border-radius:4px;
}

.container{max-width:1100px;margin:auto;padding:20px}

.card{
  background:white;
  padding:20px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
}

.satker-title{font-size:18px;font-weight:bold;margin-bottom:5px}
.periode-info{font-size:14px;color:#d9534f;margin-bottom:10px}
.periode-select{margin-bottom:20px}

select{padding:6px 10px;font-size:14px}

.row{display:flex;gap:20px;flex-wrap:wrap}
.col{flex:1;min-width:300px}

.section h3{margin-bottom:10px;color:#4e73a8}

.box{
  background:#f8f9fc;
  padding:12px;
  border-radius:6px;
  border:1px solid #d1d3e2;
  line-height:1.8;
}

.hijau{color:#1e7e34;font-weight:bold}
.kuning{color:#856404;font-weight:bold}
.merah{color:#721c24;font-weight:bold}

.warning{padding:15px;border-radius:6px;font-weight:bold;height:83%}
.warning-merah{background:#f8d7da;border:1px solid #f5c6cb;color:#721c24}
.warning-hijau{background:#d4edda;border:1px solid #c3e6cb;color:#155724}

@media(max-width:768px){.row{flex-direction:column}}
</style>
</head>

<body>

<div class="header">
  <div>Monitoring Deviasi</div>
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div class="container">
  <div class="card">

    <div class="satker-title" id="infoSatker"></div>
    <div class="periode-info" id="infoPeriode"></div>

    <div class="periode-select">
      <label>Pilih Periode: </label>
      <select id="periodeSelect"></select>
    </div>

    <div class="row">
      <div class="col">
        <div class="section">
          <h3>Rencana</h3>
          <div class="box" id="rencana"></div>
        </div>
      </div>

      <div class="col">
        <div class="section">
          <h3>Realisasi</h3>
          <div class="box" id="realisasi"></div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:20px;">
      <div class="col">
        <div class="section">
          <h3>Deviasi ( % & Nominal )</h3>
          <div class="box" id="deviasiGabungan"></div>
        </div>
      </div>

      <div class="col">
        <div id="warningBox" class="warning" style="display:none;"></div>
      </div>
    </div>

  </div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbwpvdZFaDEO909RnVLhU2b6bi6Oy1hUMZCpTK1kY8brT5RLMcnd5HZatk5ETFaMlRns/exec";

let satker=localStorage.getItem("satker")||"";
satker=satker.toString().trim();

if(!satker){window.location.href="index.html";}

function formatSatker(k){return k.toString().padStart(6,"0");}

const bulan=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];

const select=document.getElementById("periodeSelect");

bulan.forEach((b,i)=>{
  const opt=document.createElement("option");
  opt.value=(i+1).toString();
  opt.textContent=b;
  select.appendChild(opt);
});

const bulanSekarang=(new Date().getMonth()+1).toString();
select.value=bulanSekarang;

loadData(bulanSekarang);

select.addEventListener("change",function(){
  loadData(this.value);
});

function showLoading(){
  const txt="<div style='color:#4e73a8;font-style:italic;'>Sedang Load Data...</div>";
  rencana.innerHTML=txt;
  realisasi.innerHTML=txt;
  deviasiGabungan.innerHTML=txt;
  infoPeriode.innerHTML="";
  warningBox.style.display="none";
}

function clearData(){
  rencana.innerHTML="";
  realisasi.innerHTML="";
  deviasiGabungan.innerHTML="";
  warningBox.style.display="none";
}

function loadData(periode){

  showLoading();

  const url=`${API_URL}?action=getData&satker=${encodeURIComponent(satker)}&periode=${encodeURIComponent(periode)}`;

  fetch(url)
  .then(r=>r.json())
  .then(data=>{

    if(data.status==="not_found_periode"){
  infoSatker.innerHTML=`Satker: ${formatSatker(data.kodeSatker)} - ${data.namaSatker}`;
  infoPeriode.innerHTML=`Data bulan ${bulan[periode-1]} tidak tersedia`;
  clearData();
  return;
}

    if(data.status==="ok"){
      infoSatker.innerHTML=`Satker: ${formatSatker(data.kodeSatker)} - ${data.namaSatker}`;
      infoPeriode.innerHTML="";
      tampilkanRupiah("rencana",data.rencana);
      tampilkanRupiah("realisasi",data.realisasi);
      tampilkanDeviasiGabungan(data.deviasiNominal,data.deviasiPersen);
      return;
    }

    clearData();
    rencana.innerHTML="Data tidak ditemukan";
  })
  .catch(()=>{
    clearData();
    rencana.innerHTML="Gagal memuat data";
  });
}

function tampilkanRupiah(id,obj){
  let html="";
  for(let k in obj){
    const bold=(k=="51"||k=="52"||k=="53"||k=="57");
    html+=`
      <div>
        <span style="${bold?'font-weight:bold;':''}">${k}</span> :
        <span>Rp ${format(obj[k])}</span>
      </div>`;
  }
  document.getElementById(id).innerHTML=html;
}

function tampilkanDeviasiGabungan(nominal,persen){

  let html="";
  let maxPersen=0;

  for(let k in nominal){

    let n=Number(nominal[k]||0);
    let p=Number(persen[k]||0);

    if(p>maxPersen) maxPersen=p;

    let warna="hijau";
    if(p>0 && p<5) warna="kuning";
    if(p>=5) warna="merah";

    const bold=(k=="51"||k=="52"||k=="53"||k=="57");

    html+=`
      <div class="${warna}">
        <span style="${bold?'font-weight:bold;':''}">${k}</span> :
        <span>${format(p)} % : Rp ${format(n)}</span>
      </div>`;
  }

  deviasiGabungan.innerHTML=html;

  /* =========================
     WARNING BERDASARKAN MAX %
  ========================== */
  warningBox.style.display="block";

  if(maxPersen>=5){
    warningBox.className="warning warning-merah";
    warningBox.innerHTML="Deviasi masih di atas 5%, segera lakukan langkah-langkah pengurangan Deviasi";
  }
  else if(maxPersen>0 && maxPersen<5){
    warningBox.className="warning";
    warningBox.style.background="#fff3cd";
    warningBox.style.border="1px solid #ffeeba";
    warningBox.style.color="#856404";
    warningBox.innerHTML="Selamat, Deviasi sudah dibawah 5%, namun demikian masih bisa dioptimalkan, lakukan langkah-langkah pengurangan Deviasi";
  }
  else{
    warningBox.className="warning warning-hijau";
    warningBox.innerHTML="Terima kasih, deviasi tidak ada. Kinerja pelaksanaan anggaran optimal";
  }
}

function format(x){return new Intl.NumberFormat("id-ID").format(x);}

function logout(){
  localStorage.clear();
  window.location.href="index.html";
}
</script>
</body>
</html>